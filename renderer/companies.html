<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Companies â€” Tally Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=balance,cached,checkbook,dashboard,database,delete,diversity_3,inventory_2,pages,sheets_rtl,visibility" />
    <script src="dark.js"></script>
  </head>
  <body class="h-full bg-slate-50 text-slate-800">
    <div class="h-full flex">
      <aside class="side-nav" style="min-height:100vh; width:260px; background:#1e40af; padding:20px;">
        <div style="background-color: none; width: auto; margin: 0; border-radius: 10px; min-height: 50px;">
           <div class="grid-logo">
            <div class="sidebar-demo">
              <div class="logo-1">
                <div class="brand-name">
                  <span>C</span><span>o</span><span>c</span><span>h</span><span>i</span><span>n</span>
                </div>
                  <div class="subtitle">CONNECT</div>
              </div>
              <div class="label">Tally is connected with ODBC server</div>
            </div>
          </div>
        <nav class="space-y-1 text-sm" style="margin-top:30px;">
          <div style="color:#93c5fd; font-size:11px; font-weight:600; margin:16px 0 8px 0;">MAIN</div>
          <a href="index.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:white; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">dashboard</span>
            <span>Dashboard</span>
          </a>
          <a href="companies.html" style="display:flex; align-items:center; gap:10px; background:#2563eb; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">checkbook</span>
            <span>Companies</span>
          </a>
          <div style="color:#93c5fd; font-size:11px; font-weight:600; margin:16px 0 8px 0;">COMPANY DATA</div>
          <a href="ledgers.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">checkbook</span>
            <span>Ledgers</span>
          </a>
          <a href="parties.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">diversity_3</span>
            <span>Parties</span>
          </a>
          <a href="stock.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">inventory_2</span>
            <span>Stock Items</span>
          </a>
          <div style="color:#93c5fd; font-size:11px; font-weight:600; margin:16px 0 8px 0;">REPORTS</div>
          <a href="reports.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">balance</span>
            <span>Balancesheet</span>
          </a>
          <a href="reports.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">pages</span>
            <span>Day Book</span>
          </a>
          <a href="reports.html" style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:6px; color:#dbeafe; text-decoration:none;">
            <span class="material-symbols-outlined" style="font-size:20px;">sheets_rtl</span>
            <span>Profit & Loss A/C</span>
          </a>
        </nav>
        <!-- <div style="border-radius: 50%; height: 400px; width: 100px;"></div>
        <img src="./public/co_logo.png" alt="Cochin Traders Logo" class="mx-auto mt-12" style="width:180px; height:180px; border-radius:8px; object-fit:contain;" />
        <h6>COCHIN TRADERS</h6> -->
        </div>
      </aside>

      <main class="flex-1 p-6 overflow-auto">
        <header class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold" style="color: #000;">Companies</h1>
            <div class="text-sm text-gray-500">Companies stored in database</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-sm text-gray-600">
              <span id="activeCompanyName" style="font-weight: 600; color: #059669;">Tally @ PORT:9000</span>
            </div>
            <div class="flex items-center ml-3">
              <input id="navThemeToggle" type="checkbox" class="hidden" />
              <button id="navThemeBtn" aria-label="Toggle theme" class="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ðŸŒ™</button>
            </div>
          </div>
        </header>
        <section>
          <div class="flex justify-between items-center mb-4">
            <h3 style="color:#000;font-weight:600;font-size:18px;">Companies in Database [<strong id="totalCompaniesDb" style="padding:0 8px;">0</strong>]</h3>
            <button id="refreshCompaniesDb" class="px-2 py-2 rounded btn" style="border-radius:15px;">
              <span class="material-symbols-outlined" id="refresh-icon">cached</span>
            </button>
          </div>
          <div id="companiesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </section>
      </main>
    </div>
    <script>
      ;(function(){
        const grid = document.getElementById('companiesGrid')
        const totalEl = document.getElementById('totalCompaniesDb')
        const refreshBtn = document.getElementById('refreshCompaniesDb')

        function makeCard(doc){
          const name = doc.companyName || (doc.companyDetails && (doc.companyDetails.companyName||'')) || 'Unknown'
          const id = doc._id || ''
          const address = (doc.companyDetails && doc.companyDetails.address) || ''
          const email = (doc.companyDetails && doc.companyDetails.email) || ''
          const phone = (doc.companyDetails && doc.companyDetails.phone) || ''
          const startDate = (doc.companyDetails && doc.companyDetails.startDate) || ''
          const booksFrom = (doc.companyDetails && doc.companyDetails.booksFrom) || ''
          const fetchedAt = doc.fetchedAt || ''
          const firstSyncedAt = doc.firstSyncedAt || ''
          const lastSyncedAt = doc.lastSyncedAt || ''
          const ledgersCount = doc.ledgersCount ?? 0
          const stocksCount = doc.stocksCount ?? 0
          const partiesCount = doc.partiesCount ?? 0
          const el = document.createElement('div')
          el.className = 'p-4 bg-white rounded shadow card'
          el.style.cursor = 'pointer'
          el.style.overflow = 'hidden'
          el.dataset.name = name
          el.innerHTML = `
            <div class="mb-2">
              <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" class="font-semibold" style="color:#000">${name}</div>
              <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" class="text-xs text-gray-500">ID: ${id}</div>
            </div>
            <button class="delete-btn inline-flex items-center justify-center" title="Delete company" style="width:28px;height:28px;border-radius:6px;background:#fee2e2;color:#dc2626;float:right;">
              <span class="material-symbols-outlined" style="font-size:18px;">delete</span>
            </button>
            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" class="text-sm text-gray-600">${address || ''}</div>
            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" class="text-sm text-gray-600">${email || '<br/>'}</div>
            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" class="text-sm text-gray-600">${phone || ''}</div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="bg-blue-50 rounded p-2 text-center">
                <div style="font-weight:700;color:#2563eb">${ledgersCount}</div>
                <div class="text-xs text-blue-700">Ledgers</div>
              </div>
              <div class="bg-emerald-50 rounded p-2 text-center">
                <div style="font-weight:700;color:#059669">${stocksCount}</div>
                <div class="text-xs text-emerald-700">Stocks</div>
              </div>
              <div class="bg-amber-50 rounded p-2 text-center">
                <div style="font-weight:700;color:#d97706">${partiesCount}</div>
                <div class="text-xs text-amber-700">Parties</div>
              </div>
            </div>
            <div class="mt-3 flex justify-between align-center text-xs text-gray-500">
              <div>Start: ${startDate || '-'}</div>
              <div> | </div>
              <div>Books: ${booksFrom || '-'}</div>
            </div>
            <br>
            <div class="mt-1 text-xs text-gray-500>
              <div style="display:flex; flex-direction:column;">
                <div>Last Sync: </div>
                <div>${lastSyncedAt ? new Date(lastSyncedAt).toLocaleString() : '-'}</div>
              </div>
            </div>
          `
          return el
        }

        function renderSkeleton(){
          grid.innerHTML = `
            <div class="skeleton-card">
              <div class="skeleton-line skeleton-header"></div>
              <div class="skeleton-line skeleton-sub"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
            </div>
             <div class="skeleton-card">
              <div class="skeleton-line skeleton-header"></div>
              <div class="skeleton-line skeleton-sub"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
            </div>
             <div class="skeleton-card">
              <div class="skeleton-line skeleton-header"></div>
              <div class="skeleton-line skeleton-sub"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
            </div>
             </div>
             <div class="skeleton-card">
              <div class="skeleton-line skeleton-header"></div>
              <div class="skeleton-line skeleton-sub"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
            </div>
          `
        }

        async function load(){
          renderSkeleton()
          try{
            const res = await fetch('http://localhost:3000/api/companies-data', {
              headers: {
                "x-api-key": "2a54ff0c0b16c5eccf1f88c633119f3c37c3b9a697c89e875a48b435400bb755"
              }
            })
            if(!res.ok) throw new Error(await res.text())
            const json = await res.json()
            const data = json.data || []
            totalEl.textContent = String(data.length)
            grid.innerHTML = ''
            if(data.length===0){
              grid.innerHTML = '<div style="grid-column:1/-1;padding:24px;text-align:center;color:#666">No companies in database</div>'
              return
            }
            data.forEach(doc => { grid.appendChild(makeCard(doc)) })
            attachDeleteHandlers()
          }catch(err){
            grid.innerHTML = '<div style="grid-column:1/-1;padding:24px;text-align:center;color:#dc2626">Error: '+ (err.message||err) +'</div>'
          }
        }

        function attachDeleteHandlers(){
          grid.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation()
              const card = e.target.closest('.card')
              const name = card && card.dataset && card.dataset.name
              if(!name) return
              const ok = window.confirm('Delete "'+ name +'" from database?')
              if(!ok) return
              try{
                const r = await fetch('http://localhost:3000/api/company/' + encodeURIComponent(name), {
                  method: 'DELETE',
                  headers: {
                    "x-api-key": "2a54ff0c0b16c5eccf1f88c633119f3c37c3b9a697c89e875a48b435400bb755"
                  }
                })
                if(!r.ok){
                  const t = await r.text()
                  throw new Error(t)
                }
                card.remove()
                const current = Number((document.getElementById('totalCompaniesDb').textContent||'0'))
                document.getElementById('totalCompaniesDb').textContent = String(Math.max(0, current - 1))
              }catch(err){
                alert('Delete failed: ' + (err.message || err))
              }
            })
          })
        }
        async function startRefreshAnimation() {
          const icon = document.getElementById('refresh-icon');
          // Add the spin class to start the animation
          icon.classList.add('spin');

          // Remove the class after the animation finishes
          // The duration (500ms) should match the CSS animation duration
          setTimeout(() => {
            icon.classList.remove('spin');
          }, 500);
        }

        if(refreshBtn){ 
          refreshBtn.addEventListener('click', async () => {
            try{ startRefreshAnimation() }catch(e){}
            await load()
          })
        }
        load()
      })();
    </script>
  </body>
</html>
